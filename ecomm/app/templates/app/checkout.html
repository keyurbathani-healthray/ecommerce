{% extends 'app/layout.html' %}
{% load static %}
{% block title %}Checkout - Complete Your Order{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="bg-light py-4 mb-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="display-6 fw-bold text-dark mb-2">
                    <i class="fas fa-shopping-bag text-success me-2"></i>Checkout
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'show-cart' %}" class="text-decoration-none">Cart</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    <!-- Messages Alert -->
    {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for msg in messages %}
                <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error!</strong> {{msg}}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Checkout Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-center flex-fill">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                            <p class="mb-0 mt-2 small fw-bold">Cart</p>
                        </div>
                        <div class="flex-fill"><hr class="border-success border-2"></div>
                        <div class="text-center flex-fill">
                            <i class="fas fa-map-marker-alt fa-2x text-success"></i>
                            <p class="mb-0 mt-2 small fw-bold text-success">Address</p>
                        </div>
                        <div class="flex-fill"><hr class="border-2"></div>
                        <div class="text-center flex-fill">
                            <i class="fas fa-credit-card fa-2x text-muted"></i>
                            <p class="mb-0 mt-2 small text-muted">Payment</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Order Summary Section -->
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-success text-white py-3">
                    <h4 class="mb-0">
                        <i class="fas fa-receipt me-2"></i>Order Summary
                    </h4>
                </div>
                <div class="card-body p-4">
                    <!-- STEP 1-2: Display all cart items with product details -->
                    {% for item in cart_items %}
                    <div class="card mb-3 border">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5 class="mb-2 fw-bold text-dark">
                                        <i class="fas fa-box-open text-success me-2"></i>{{item.product.title}}
                                    </h5>
                                    <p class="mb-1 text-muted">
                                        <i class="fas fa-cubes me-2"></i>Quantity: <span class="badge bg-secondary">{{item.quantity}}</span>
                                    </p>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <h5 class="text-success fw-bold mb-0">
                                        <i class="fas fa-rupee-sign"></i> {{item.product.discounted_price}}
                                    </h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- STEP 3: Display total amount (cart total + ₹40 shipping) -->
                    <div class="card bg-light border-0 mt-4">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Subtotal:</span>
                                <span class="fw-bold"><i class="fas fa-rupee-sign"></i> {{amount}}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Shipping:</span>
                                <span class="fw-bold text-success"><i class="fas fa-rupee-sign"></i> 40</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Total Amount:</h5>
                                <h4 class="mb-0 text-primary fw-bold">
                                    <i class="fas fa-rupee-sign"></i> {{totalamount}}
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>Terms and Conditions
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Quod optio vel id rem, autem similique aspernatur officiis alias! Blanditiis atque deleniti, odit laboriosam accusamus voluptas quasi autem reprehenderit ut quis.
                    </p>
                </div>
            </div>
        </div>

        <!-- Shipping Address Section -->
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Select Shipping Address
                    </h4>
                </div>
                <div class="card-body p-4">
                    <!-- Payment form - contains address selection -->
                    <form method="post" id="myform">
                        {% csrf_token %}
                        
                        {% if add %}
                            <!-- Loop through all saved addresses -->
                            {% for ad in add %}
                            <div class="card mb-3 border address-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-start">
                                        <div class="form-check me-3">
                                            <input class="form-check-input border border-dark" type="radio" name="custid" id="custadd{{forloop.counter}}" value="{{ad.id}}" {% if forloop.first %}checked{% endif %}>
                                        </div>
                                        <div class="flex-fill">
                                            <label class="form-check-label w-100" for="custadd{{forloop.counter}}">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="fw-bold text-dark mb-0">
                                                        <i class="fas fa-user me-2 text-success"></i>{{ad.name}}
                                                    </h6>
                                                    <span class="badge bg-success">Address {{forloop.counter}}</span>
                                                </div>
                                                <p class="mb-1 text-muted small">
                                                    <i class="fas fa-phone me-2"></i>Mobile: {{ad.mobile}}
                                                </p>
                                                <p class="mb-0 text-muted small">
                                                    <i class="fas fa-map-pin me-2"></i>{{ad.locality}}, {{ad.city}}, {{ad.state}} - {{ad.zipcode}}
                                                </p>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No saved addresses found. Please add an address first.
                            </div>
                        {% endif %}

                        <!-- Total Amount Display -->
                        <div class="mb-4">
                            <label for="totamount" class="form-label fw-bold">
                                <i class="fas fa-money-bill-wave me-2"></i>Total Amount
                            </label>
                            <!-- Display total amount (read-only) -->
                            <div class="input-group">
                                <span class="input-group-text bg-success text-white">
                                    <i class="fas fa-rupee-sign"></i>
                                </span>
                                <input type="number" class="form-control fw-bold fs-5" name="totamount" id="totamount" value={{totalamount}} readonly>
                            </div>
                        </div>

                        <!-- Payment Button -->
                        <div class="d-grid gap-2">
                            <!-- STEP 6: Payment button - When clicked, opens Razorpay modal -->
                            <button id="rzp-button1" type="submit" class="btn btn-warning btn-lg fw-bold shadow">
                                <i class="fas fa-lock me-2"></i>Proceed to Payment
                            </button>
                        </div>

                        <!-- Security Badge -->
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt me-1"></i>100% Secure Payment
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

 {% block payment-gateway %}

<!-- Load Razorpay JavaScript library -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
// Configure Razorpay payment modal options
var options = {
    // API Key from Razorpay Dashboard
    "key": "rzp_test_RbHEGAnfXfDDMD",
    
    // Amount in paise (passed from backend - e.g., 25600 paise = ₹256)
    "amount": "{{razoramount}}",
    
    // Currency code
    "currency": "INR",
    
    // Business/Store name displayed in payment modal
    "name": "Neel Product",
    
    // Description shown in payment modal
    "description": "purchase products",
    
    // Optional: Your logo URL
    // "image": "https://example.com/your_logo",
    
    // IMPORTANT: Order ID created on backend (e.g., 'order_RbbSoOOag4InGB')
    // This links payment to the order we created in checkout view
    "order_id": "{{order_id}}",
    
    // STEP 10: Handler function - Executes when payment is SUCCESSFUL
    "handler": function (response){
        // Get the form to extract selected address
        var form = document.getElementById('myform');
        
        // Razorpay sends these after successful payment:
        // response.razorpay_payment_id - Unique payment ID (e.g., 'pay_RbcZ8PhVlUEuka')
        // response.razorpay_order_id - Order ID we created (e.g., 'order_RbbSoOOag4InGB')
        // response.razorpay_signature - Signature for verification (optional)
        
        // Uncomment to debug:
        // alert(response.razorpay_payment_id);
        // alert(response.razorpay_order_id);
        // alert(response.razorpay_signature);
        
        // Redirect to payment completion page with payment details
        // This sends order_id, payment_id, and customer address to backend
        window.location.href = `http://localhost:8001/paymentdone?order_id=${response.razorpay_order_id}&payment_id=${response.razorpay_payment_id}&cust_id=${form.elements["custid"].value}`
    },
    
    // Pre-fill customer information (optional - improves conversion)
    "prefill": {
        "name": "<name>",
        "email": "<email>", 
        "contact": "<phone>"
    },
    
    // Additional notes (optional)
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    
    // Customize modal theme color
    "theme": {
        "color": "#3399cc"
    }
};

// STEP 8: Initialize Razorpay payment object with above options
var rzp1 = new Razorpay(options);

// STEP 9: Handle payment failure
rzp1.on('payment.failed', function (response){
    // Display error details if payment fails
    alert(response.error.code);
    alert(response.error.description);
    alert(response.error.source);
    alert(response.error.step);
    alert(response.error.reason);
    alert(response.error.metadata.order_id);
    alert(response.error.metadata.payment_id);
});

// STEP 7: When user clicks Payment button, open Razorpay modal
document.getElementById('rzp-button1').onclick = function(e){
    rzp1.open();        // Open Razorpay payment modal
    e.preventDefault(); // Prevent default form submission
}
</script>



{% endblock %} 